\begin{Verbatim}[commandchars=\\\{\}]
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}Computation.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}DiscreteDerivatives.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}ReductionKernels.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZlt{}cmath\PYGZgt{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Performs the unparallelisable part of ComputeGamma on the GPU to avoid having to copy memory to the CPU. Requires 1 thread.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{FinishComputeGamma}\PYG{p}{(}\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{hVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{vVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{horizontalComponent}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{hVelMax}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{*}\PYG{n}{timestep}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{verticalComponent}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{vVelMax}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{*}\PYG{n}{timestep}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{);}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{horizontalComponent}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{verticalComponent}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{o}{*}\PYG{n}{gamma}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{horizontalComponent}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{o}{*}\PYG{n}{gamma}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{verticalComponent}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}

\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{ComputeGamma}\PYG{p}{(}\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{cudaStream\PYGZus{}t}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{retVal}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{hVelMax}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMalloc}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{hVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{));}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{vVelMax}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMalloc}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{vVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{));}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{FieldMax}\PYG{p}{(}\PYG{n}{hVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{],}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaStreamSynchronize}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]);}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{FieldMax}\PYG{p}{(}\PYG{n}{vVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{],}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaStreamSynchronize}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]);}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{FinishComputeGamma}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{);}

\PYG{+w}{    }\PYG{n+nl}{free}\PYG{p}{:}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{hVelMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{vVelMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{retVal}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Performs the unparallelisable part of ComputeTimestep on the GPU to avoid having to copy memory to the CPU. Requires 1 thread.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{FinishComputeTimestep}\PYG{p}{(}\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{hVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{vVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{reynoldsNo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{safetyFactor}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{inverseSquareRestriction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{)}\PYG{l+m+mf}{0.5}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{reynoldsNo}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{square}\PYG{p}{(}\PYG{n}{delX}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{square}\PYG{p}{(}\PYG{n}{delY}\PYG{p}{));}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{xTravelRestriction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{delX}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{hVelMax}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{yTravelRestriction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{delY}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{vVelMax}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{smallestRestriction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{inverseSquareRestriction}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Choose the smallest restriction}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{xTravelRestriction}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{smallestRestriction}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{smallestRestriction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{xTravelRestriction}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{yTravelRestriction}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{smallestRestriction}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{smallestRestriction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{yTravelRestriction}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{o}{*}\PYG{n}{timestep}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{safetyFactor}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{smallestRestriction}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{ComputeTimestep}\PYG{p}{(}\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{cudaStream\PYGZus{}t}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{reynoldsNo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{safetyFactor}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{retVal}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{hVelMax}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMalloc}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{hVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{));}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{vVelMax}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMalloc}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{vVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{));}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{FieldMax}\PYG{p}{(}\PYG{n}{hVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{],}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaStreamSynchronize}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]);}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{FieldMax}\PYG{p}{(}\PYG{n}{vVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{],}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaStreamSynchronize}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]);}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{FinishComputeTimestep}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVelMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{reynoldsNo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{safetyFactor}\PYG{p}{);}

\PYG{n+nl}{free}\PYG{p}{:}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{hVelMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{vVelMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{retVal}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Computes F on the top and bottom of the simulation domain. Requires jMax threads.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{ComputeFBoundary}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{F}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{F}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{);}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Computes G on the left and right of the simulation domain. Requires iMax threads.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{ComputeGBoundary}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{G}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{G}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Computes quantity F. Requires (iMax \PYGZhy{} 1) x (jMax) threads.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{ComputeF}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{xForce}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{reynoldsNum}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}=}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{selfBit}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{SELF}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{SELFSHIFT}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// SELF bit of the cell\PYGZsq{}s flag}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{eastBit}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{EAST}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{EASTSHIFT}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// EAST bit of the cell\PYGZsq{}s flag}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{F}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}
\PYG{+w}{        }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selfBit}\PYG{+w}{ }\PYG{o}{|}\PYG{+w}{ }\PYG{n}{eastBit}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// For boundary cells or fluid cells, add hVel}
\PYG{+w}{        }\PYG{o}{+}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{timestep}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{reynoldsNum}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{SecondPuPx}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{SecondPuPy}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{PuSquaredPx}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{gamma}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{PuvPy}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{gamma}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{xForce}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selfBit}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{eastBit}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// For fluid cells only, perform the computation. Obstacle cells without an eastern boundary are set to 0.}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Computes quantity G. Requires (iMax) x (jMax \PYGZhy{} 1) threads.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{ComputeG}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{yForce}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{reynoldsNum}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}=}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{selfBit}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{SELF}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{SELFSHIFT}\PYG{p}{;}\PYG{+w}{    }\PYG{c+c1}{// SELF bit of the cell\PYGZsq{}s flag}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{northBit}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{NORTH}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{NORTHSHIFT}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// NORTH bit of the cell\PYGZsq{}s flag}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{G}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}
\PYG{+w}{        }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selfBit}\PYG{+w}{ }\PYG{o}{|}\PYG{+w}{ }\PYG{n}{northBit}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// For boundary cells or fluid cells, add vVel}
\PYG{+w}{        }\PYG{o}{+}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{timestep}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{reynoldsNum}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{SecondPvPx}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{SecondPvPy}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{PuvPx}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{gamma}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{PvSquaredPy}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{gamma}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{yForce}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selfBit}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{northBit}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// For fluid cells only, perform the computation. Obstacle cells without a northern boundary are set to 0.}
\PYG{p}{\PYGZcb{}}

\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{ComputeFG}\PYG{p}{(}\PYG{n}{cudaStream\PYGZus{}t}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{xForce}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{yForce}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{reynoldsNum}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n+nf}{numBlocksF}\PYG{p}{(}\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{));}
\PYG{+w}{    }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n+nf}{numBlocksG}\PYG{p}{(}\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{));}

\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlat}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numBlocksIMax}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlat}\PYG{p}{);}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numBlocksJMax}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlat}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{ComputeF}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksF}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{xForce}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{reynoldsNum}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Launch the kernels in separate streams, to be concurrently executed if the GPU is able to.}
\PYG{+w}{    }\PYG{n}{ComputeG}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksG}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{yForce}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{reynoldsNum}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{ComputeFBoundary}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksJMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlat}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{ComputeGBoundary}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksIMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlat}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}

\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{cudaDeviceSynchronize}\PYG{p}{();}
\PYG{p}{\PYGZcb{}}

\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{ComputeRHS}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{RHS}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{RHS}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{RHS}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }
\PYG{+w}{        }\PYG{p}{((}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{SELF}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{SELFSHIFT}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// Sets the entire expression to 0 if the cell is not fluid}
\PYG{+w}{        }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{timestep}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(((}\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{F}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{F}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{G}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{G}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{));}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Computes horizontal velocity. Requires iMax x jMax threads, called by ComputeVelocities.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{ComputeHVel}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Bounds checking}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}
\PYG{+w}{        }\PYG{p}{((}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{SELF}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{SELFSHIFT}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// Equal to 0 if the cell is not a fluid cell}
\PYG{+w}{        }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{EAST}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{EASTSHIFT}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// Equal to 0 if the cell has an obstacle cell next to it in +ve x direction (east)}
\PYG{+w}{        }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{F}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{*}\PYG{n}{timestep}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)));}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Computes vertical velocity. Requires iMax x jMax threads, called by ComputeVelocities.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{ComputeVVel}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Bounds checking}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}
\PYG{+w}{        }\PYG{p}{((}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{SELF}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{SELFSHIFT}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// Equal to 0 if the cell is not a fluid cell}
\PYG{+w}{        }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{NORTH}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{NORTHSHIFT}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// Equal to 0 if the cell has an obstacle cell next to it in +ve y direction (north)}
\PYG{+w}{        }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{G}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{*}\PYG{n}{timestep}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)));}
\PYG{p}{\PYGZcb{}}

\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{ComputeVelocities}\PYG{p}{(}\PYG{n}{cudaStream\PYGZus{}t}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n+nf}{numBlocks}\PYG{p}{(}\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{));}
\PYG{+w}{    }\PYG{n}{ComputeHVel}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocks}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Launch the kernels in separate streams, to be concurrently executed if the GPU is able to.}
\PYG{+w}{    }\PYG{n}{ComputeVVel}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocks}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{);}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{cudaDeviceSynchronize}\PYG{p}{();}
\PYG{p}{\PYGZcb{}}

\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{ComputeStream}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Stream function boundary condition}
\PYG{+w}{    }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZlt{}=}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{colNum}\PYG{o}{++}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}
\end{Verbatim}

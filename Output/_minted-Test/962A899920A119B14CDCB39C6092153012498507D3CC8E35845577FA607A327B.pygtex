\begin{Verbatim}[commandchars=\\\{\}]
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}PressureComputation.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}DiscreteDerivatives.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}ReductionKernels.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZlt{}cmath\PYGZgt{}}


\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Calculates and validates the coordinates of a thread based on the coloured cell system.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{c+c1}{/// \PYGZlt{}param name=\PYGZdq{}rowNum\PYGZdq{}\PYGZgt{}The output row number (x coordinate).\PYGZlt{}/param\PYGZgt{}}
\PYG{c+c1}{/// \PYGZlt{}param name=\PYGZdq{}colNum\PYGZdq{}\PYGZgt{}The output column number (y coordinate).\PYGZlt{}/param\PYGZgt{}}
\PYG{c+c1}{/// \PYGZlt{}param name=\PYGZdq{}threadPosX\PYGZdq{}\PYGZgt{}X position of the thread in the grid.\PYGZlt{}/param\PYGZgt{}}
\PYG{c+c1}{/// \PYGZlt{}param name=\PYGZdq{}threadPosY\PYGZdq{}\PYGZgt{}Y position of the thread in the grid.\PYGZlt{}/param\PYGZgt{}}
\PYG{c+c1}{/// \PYGZlt{}param name=\PYGZdq{}colourNum\PYGZdq{}\PYGZgt{}The desired colour of the returned coordinates\PYGZlt{}/param\PYGZgt{}}
\PYG{c+c1}{/// \PYGZlt{}param name=\PYGZdq{}numberOfColours\PYGZdq{}\PYGZgt{}The number of different colours assigned to cells.\PYGZlt{}/param\PYGZgt{}}
\PYG{c+c1}{/// \PYGZlt{}returns\PYGZgt{}Whether the thread coordinates map to a valid cell.\PYGZlt{}/returns\PYGZgt{}}
\PYG{k+kt}{\PYGZus{}\PYGZus{}device\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{bool}\PYG{+w}{ }\PYG{n}{CalculateColouredCoordinates}\PYG{p}{(}\PYG{k+kt}{int}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{threadPosX}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{threadPosY}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colourNum}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numberOfColours}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{c+c1}{// Require (rowNum + colNum) \PYGZpc{} numberOfColours = colourNum}
\PYG{+w}{    }\PYG{o}{*}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{threadPosX}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Normal rowNum \PYGZhy{} x position of thread in grid.}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colOffset}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{colourNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZpc{}}\PYG{+w}{ }\PYG{n}{numberOfColours}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// The number to add to the column number (the required result of colNum \PYGZpc{} numberOfColours, subtracted 1 to avoid colNum being 0).}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colOffset}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{colOffset}\PYG{+w}{ }\PYG{o}{+=}\PYG{+w}{ }\PYG{n}{numberOfColours}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{o}{*}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{numberOfColours}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{threadPosY}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{colOffset}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Generate colNum such that colNum \PYGZpc{} numberOfColours = colOffset.}

\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZlt{}=}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{\PYGZam{}\PYGZam{}}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZlt{}=}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Gets the parity (number of bits that are set mod 2) of a byte.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{c+c1}{/// \PYGZlt{}param name=\PYGZdq{}input\PYGZdq{}\PYGZgt{}The input byte\PYGZlt{}/param\PYGZgt{}}
\PYG{c+c1}{/// \PYGZlt{}returns\PYGZgt{}The parity of the byte, 1 or 0.\PYGZlt{}/returns\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}host\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{\PYGZus{}\PYGZus{}device\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{n}{BYTE}\PYG{+w}{ }\PYG{n}{GetParity}\PYG{p}{(}\PYG{n}{BYTE}\PYG{+w}{ }\PYG{n}{input}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{input}\PYG{+w}{ }\PYG{o}{\PYGZca{}=}\PYG{+w}{ }\PYG{n}{input}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{4}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Repeatedly shift\PYGZhy{}XOR to end up with the XOR of all of the bits in the LSB.}
\PYG{+w}{    }\PYG{n}{input}\PYG{+w}{ }\PYG{o}{\PYGZca{}=}\PYG{+w}{ }\PYG{n}{input}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{input}\PYG{+w}{ }\PYG{o}{\PYGZca{}=}\PYG{+w}{ }\PYG{n}{input}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{input}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// The parity is stored in the last bit, so XOR the result with 1 and return.}
\PYG{p}{\PYGZcb{}}


\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Calculates pressures of one colour of the grid. Requires iMax x (jMax / numberOfColours) threads.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{SingleColourSOR}\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numberOfColours}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colourNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{RHS}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{residualArray}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{omega}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{boundaryFraction}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{bool}\PYG{+w}{ }\PYG{n}{validCell}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{CalculateColouredCoordinates}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{colNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{y}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colourNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{numberOfColours}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{!}\PYG{n}{validCell}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// If the cell is not valid, do not perform the computation}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{SELF}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{==}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// If the cell is not a fluid cell, also do not perform the computation.}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{relaxedPressure}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{omega}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{pressureAverages}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{square}\PYG{p}{(}\PYG{n}{delX}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{square}\PYG{p}{(}\PYG{n}{delY}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{RHS}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{RHS}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{relaxedPressure}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{boundaryFraction}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{pressureAverages}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{currentResidual}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{pressureAverages}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{square}\PYG{p}{(}\PYG{n}{delX}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{square}\PYG{p}{(}\PYG{n}{delY}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{residualArray}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{residualArray}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{square}\PYG{p}{(}\PYG{n}{currentResidual}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Residual array is shifted down and left 1 so less memory is needed.}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Copies pressure values at the top and bottom of the simulation domain. Requires iMax threads.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{CopyHorizontalPressures}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Copies pressure values at the top and bottom of the simulation domain. Requires jMax threads.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{CopyVerticalPressures}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{);}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{c+c1}{/// Copies the pressures for the boundary cells given in \PYGZlt{}paramref name=\PYGZdq{}coordinates\PYGZdq{} /\PYGZgt{}. Requires \PYGZlt{}paramref name=\PYGZdq{}coordinatesLength\PYGZdq{} /\PYGZgt{} threads.}
\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{CopyBoundaryPressures}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{uint2}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{index}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{index}\PYG{+w}{ }\PYG{o}{\PYGZgt{}=}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{k+kt}{uint2}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{[}\PYG{n}{index}\PYG{p}{];}\PYG{+w}{ }\PYG{c+c1}{// Get coordinate from global memory...}
\PYG{+w}{    }\PYG{n}{BYTE}\PYG{+w}{ }\PYG{n}{relevantFlag}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// ...and the flag for that coordinate.}

\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xShift}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{relevantFlag}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{EAST}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{EASTSHIFT}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{relevantFlag}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{WEST}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{WESTSHIFT}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Relative position of cell to copy in x direction. \PYGZhy{}1, 0 or 1.}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yShift}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{relevantFlag}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{NORTH}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{NORTHSHIFT}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{relevantFlag}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{SOUTH}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{SOUTHSHIFT}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Relative position of cell to copy in y direction. \PYGZhy{}1, 0 or 1.}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{GetParity}\PYG{p}{(}\PYG{n}{relevantFlag}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{==}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{c+c1}{// Only boundary cells with one edge \PYGZhy{} copy from that fluid cell}
\PYG{+w}{        }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{xShift}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{yShift}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Copy from the cell determined by the shifts.}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{c+c1}{// These are boundary cells with 2 edges \PYGZhy{} take the average of the 2 cells with the boundary.}
\PYG{+w}{        }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{xShift}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{yShift}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{)}\PYG{l+m+mi}{2}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Take the average of the one above/below and the one left/right by only using one shift for each of the field accesses.}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}

\PYG{c+c1}{// Could implement this using cuda graphs}
\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{Poisson}\PYG{p}{(}\PYG{n}{cudaStream\PYGZus{}t}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{RHS}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{uint2}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numFluidCells}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numColours}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{residualTolerance}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{minIterations}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{maxIterations}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{omega}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{residualNorm}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{retVal}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numIterations}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{boundaryFraction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{omega}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{p}{((}\PYG{l+m+mi}{2}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{square}\PYG{p}{(}\PYG{n}{delX}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{square}\PYG{p}{(}\PYG{n}{delY}\PYG{p}{)));}\PYG{+w}{ }\PYG{c+c1}{// Only executed once so easier to execute on CPU and transfer.}

\PYG{+w}{    }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n}{numBlocks}\PYG{p}{(}\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{numColours}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{));}\PYG{+w}{ }\PYG{c+c1}{// Number of blocks for an iMax x jMax launch.}

\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlattened}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numBlocksIMax}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlattened}\PYG{p}{);}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numBlocksJMax}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlattened}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{residualArray}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{p}{();}\PYG{+w}{ }\PYG{c+c1}{// Create pointers and set them to null}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{d\PYGZus{}residualNorm}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{nullptr}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Create a device version of residualNorm}

\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMallocPitch}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{residualArray}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{residualArray}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Create residualArray with size iMax * jMax}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMalloc}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{d\PYGZus{}residualNorm}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{));}\PYG{+w}{ }\PYG{c+c1}{// Allocate one REAL\PYGZsq{}s worth of memory}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}


\PYG{+w}{    }\PYG{o}{*}\PYG{n}{residualNorm}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Set both host and device residual norms to 0.}
\PYG{+w}{    }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMemset}\PYG{p}{(}\PYG{n}{d\PYGZus{}residualNorm}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{));}
\PYG{+w}{    }\PYG{k}{do}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colourNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{colourNum}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{numColours}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{colourNum}\PYG{o}{++}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{c+c1}{// Loop through however many colours and perform SOR.}
\PYG{+w}{            }\PYG{n}{SingleColourSOR}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocks}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{numColours}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colourNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{RHS}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{residualArray}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{omega}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{boundaryFraction}\PYG{p}{);}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaStreamSynchronize}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]);}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Copy the boundary cell pressures all in different streams}
\PYG{+w}{        }\PYG{n}{CopyHorizontalPressures}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksIMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlattened}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{+w}{        }\PYG{n}{CopyVerticalPressures}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksJMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlockFlattened}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{+w}{        }\PYG{n}{CopyBoundaryPressures}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocks}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}

\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{numIterations}\PYG{+w}{ }\PYG{o}{\PYGZpc{}}\PYG{+w}{ }\PYG{l+m+mi}{10}\PYG{+w}{ }\PYG{o}{==}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{c+c1}{// Only calculate the residual every 10 iterations}
\PYG{+w}{            }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{FieldSum}\PYG{p}{(}\PYG{n}{d\PYGZus{}residualNorm}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{],}\PYG{+w}{ }\PYG{n}{residualArray}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMemcpy}\PYG{p}{(}\PYG{n}{residualNorm}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{d\PYGZus{}residualNorm}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{cudaMemcpyDeviceToHost}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Copy residual norm to host for processing and use in condition}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{            }\PYG{o}{*}\PYG{n}{residualNorm}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{sqrt}\PYG{p}{(}\PYG{o}{*}\PYG{n}{residualNorm}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{numFluidCells}\PYG{p}{);}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{n}{numIterations}\PYG{o}{++}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{while}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{numIterations}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{maxIterations}\PYG{+w}{ }\PYG{o}{\PYGZam{}\PYGZam{}}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{residualNorm}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{residualTolerance}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{||}\PYG{+w}{ }\PYG{n}{numIterations}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{minIterations}\PYG{p}{);}

\PYG{n+nl}{free}\PYG{p}{:}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{residualArray}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{d\PYGZus{}residualNorm}\PYG{p}{);}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{==}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{numIterations}\PYG{+w}{ }\PYG{o}{:}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Return 0 if there was an error, otherwise the number of iterations.}
\PYG{p}{\PYGZcb{}}
\end{Verbatim}

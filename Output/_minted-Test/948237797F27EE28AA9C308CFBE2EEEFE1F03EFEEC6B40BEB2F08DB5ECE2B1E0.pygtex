\begin{Verbatim}[commandchars=\\\{\}]
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}GPUSolver.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}Init.h\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}Flags.h\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}Boundary.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}Computation.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}PressureComputation.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}math.h\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZlt{}iostream\PYGZgt{}}

\PYG{n}{constexpr}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{GPU\PYGZus{}MIN\PYGZus{}MAJOR\PYGZus{}VERSION}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{6}\PYG{p}{;}

\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{GPUSolver}\PYG{p}{(}\PYG{n}{SimulationParameters}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{:}\PYG{+w}{ }\PYG{n}{Solver}\PYG{p}{(}\PYG{n}{parameters}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{hVel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{p}{();}
\PYG{+w}{    }\PYG{n}{cudaMallocPitch}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{vVel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{p}{();}
\PYG{+w}{    }\PYG{n}{cudaMallocPitch}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{pressure}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{p}{();}
\PYG{+w}{    }\PYG{n}{cudaMallocPitch}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{RHS}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{p}{();}
\PYG{+w}{    }\PYG{n}{cudaMallocPitch}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{RHS}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{RHS}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{F}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{p}{();}
\PYG{+w}{    }\PYG{n}{cudaMallocPitch}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{F}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{F}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{G}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{p}{();}
\PYG{+w}{    }\PYG{n}{cudaMallocPitch}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{G}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{G}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{streamFunction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{p}{();}
\PYG{+w}{    }\PYG{n}{cudaMallocPitch}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{devFlags}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{p}{();}
\PYG{+w}{    }\PYG{n}{cudaMallocPitch}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{devFlags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{devFlags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{BYTE}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{n}{obstacles}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{ObstacleMatrixMAlloc}\PYG{p}{(}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{transmissionHVel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{REAL}\PYG{p}{[}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{];}
\PYG{+w}{    }\PYG{n}{transmissionVVel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{REAL}\PYG{p}{[}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{];}
\PYG{+w}{    }\PYG{n}{transmissionPressure}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{REAL}\PYG{p}{[}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{];}
\PYG{+w}{    }\PYG{n}{transmissionStream}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{REAL}\PYG{p}{[}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{];}

\PYG{+w}{    }\PYG{n}{copiedHVel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{REAL}\PYG{p}{[(}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)];}
\PYG{+w}{    }\PYG{n}{copiedVVel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{REAL}\PYG{p}{[(}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)];}
\PYG{+w}{    }\PYG{n}{copiedPressure}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{REAL}\PYG{p}{[(}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)];}
\PYG{+w}{    }\PYG{n}{copiedStream}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{REAL}\PYG{p}{[(}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)];}

\PYG{+w}{    }\PYG{n}{devCoordinates}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{nullptr}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Initialised in ProcessObstacles.}
\PYG{+w}{    }\PYG{n}{streams}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{nullptr}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Initialised in PerformSetup.}
\PYG{p}{\PYGZcb{}}

\PYG{n}{GPUSolver}\PYG{o}{::\PYGZti{}}\PYG{n}{GPUSolver}\PYG{p}{()}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{streams}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{nullptr}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{totalStreams}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{++}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{cudaStreamDestroy}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]);}\PYG{+w}{ }\PYG{c+c1}{// Destroy all of the streams}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{RHS}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{F}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{G}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{devFlags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{devCoordinates}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{FreeMatrix}\PYG{p}{(}\PYG{n}{obstacles}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{transmissionHVel}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{transmissionVVel}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{transmissionPressure}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{transmissionStream}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{copiedHVel}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{copiedVVel}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{copiedPressure}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{copiedStream}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{n}{template}\PYG{o}{\PYGZlt{}}\PYG{n}{typename}\PYG{+w}{ }\PYG{n}{T}\PYG{o}{\PYGZgt{}}
\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{CopyFieldToDevice}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{T}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{devField}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{T}\PYG{o}{**}\PYG{+w}{ }\PYG{n}{hostField}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{T}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{hostFieldFlattened}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{T}\PYG{p}{[}\PYG{n}{xLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{];}
\PYG{+w}{    }\PYG{n}{FlattenArray}\PYG{p}{(}\PYG{n}{hostField}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hostFieldFlattened}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMemcpy2D}\PYG{p}{(}\PYG{n}{devField}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{devField}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hostFieldFlattened}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{yLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{T}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{yLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{T}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{cudaMemcpyHostToDevice}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{hostFieldFlattened}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{retVal}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{n}{template}\PYG{o}{\PYGZlt{}}\PYG{n}{typename}\PYG{+w}{ }\PYG{n}{T}\PYG{o}{\PYGZgt{}}
\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{CopyFieldToHost}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{T}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{devField}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{T}\PYG{o}{**}\PYG{+w}{ }\PYG{n}{hostField}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{T}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{hostFieldFlattened}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{T}\PYG{p}{[}\PYG{n}{xLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{];}

\PYG{+w}{    }\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaMemcpy2D}\PYG{p}{(}\PYG{n}{hostFieldFlattened}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{yLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{T}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{devField}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{devField}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{yLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{T}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{cudaMemcpyDeviceToHost}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{UnflattenArray}\PYG{p}{(}\PYG{n}{hostField}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hostFieldFlattened}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{hostFieldFlattened}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{retVal}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}


\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{SetBlockDimensions}\PYG{p}{()}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{c+c1}{// The below code takes the square root of the number of threads, but if the number of threads per block is not a square it takes the powers of 2 either side of the square root.}
\PYG{+w}{    }\PYG{c+c1}{// For example, a maxThreadsPerBlock of 1024 would mean threadsPerBlock becomes 32 and 32, but a maxThreadsPerBlock of 512 would mean threadsPerBlock would become 32 and 16}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{maxThreadsPerBlock}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{deviceProperties}\PYG{p}{.}\PYG{n}{maxThreadsPerBlock}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{log2ThreadsPerBlock}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{p}{)}\PYG{n}{ceilf}\PYG{p}{(}\PYG{n}{log2f}\PYG{p}{((}\PYG{k+kt}{float}\PYG{p}{)}\PYG{n}{maxThreadsPerBlock}\PYG{p}{));}\PYG{+w}{ }\PYG{c+c1}{// Threads per block should be a power of 2, but ceil just in case}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{log2XThreadsPerBlock}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{p}{)}\PYG{n}{ceilf}\PYG{p}{((}\PYG{k+kt}{float}\PYG{p}{)}\PYG{n}{log2ThreadsPerBlock}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mf}{2.0f}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Divide by 2, if log2(threadsPerBlock) was odd, ceil}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{log2YThreadsPerBlock}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{p}{)}\PYG{n}{floorf}\PYG{p}{((}\PYG{k+kt}{float}\PYG{p}{)}\PYG{n}{log2ThreadsPerBlock}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mf}{2.0f}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// As above, but floor for smaller one}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xThreadsPerBlock}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{p}{)}\PYG{n}{powf}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{float}\PYG{p}{)}\PYG{n}{log2XThreadsPerBlock}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Now exponentiate to get the actual number of threads}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yThreadsPerBlock}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{p}{)}\PYG{n}{powf}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{float}\PYG{p}{)}\PYG{n}{log2YThreadsPerBlock}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{threadsPerBlock}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kt}{dim3}\PYG{p}{(}\PYG{n}{xThreadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{yThreadsPerBlock}\PYG{p}{);}

\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{blocksForIMax}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{p}{)}\PYG{n}{ceilf}\PYG{p}{((}\PYG{k+kt}{float}\PYG{p}{)}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{p}{);}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{blocksForJMax}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{p}{)}\PYG{n}{ceilf}\PYG{p}{((}\PYG{k+kt}{float}\PYG{p}{)}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{numBlocks}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kt}{dim3}\PYG{p}{(}\PYG{n}{blocksForIMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{blocksForJMax}\PYG{p}{);}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{ResizeField}\PYG{p}{(}\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{enlargedField}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{enlargedXLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{enlargedYLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xOffset}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yOffset}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{transmissionField}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{++}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{memcpy}\PYG{p}{(}
\PYG{+w}{            }\PYG{n}{transmissionField}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{,}
\PYG{+w}{            }\PYG{n}{enlargedField}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{i}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{xOffset}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{enlargedYLength}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{yOffset}\PYG{p}{,}
\PYG{+w}{            }\PYG{n}{yLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{)}
\PYG{+w}{        }\PYG{p}{);}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}

\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{GetHorizontalVelocity}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{transmissionHVel}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{GetVerticalVelocity}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{transmissionVVel}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{GetPressure}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{transmissionPressure}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{GetStreamFunction}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{transmissionStream}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{bool}\PYG{o}{**}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{GetObstacles}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{obstacles}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{ProcessObstacles}\PYG{p}{()}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{c+c1}{// When this function is called, no streams have been created and block dimensions have not been calculated. Therefore, no kernels can be launched here.}
\PYG{+w}{    }\PYG{n}{BYTE}\PYG{o}{**}\PYG{+w}{ }\PYG{n}{hostFlags}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{FlagMatrixMAlloc}\PYG{p}{(}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{SetFlags}\PYG{p}{(}\PYG{n}{obstacles}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hostFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Set the flags on the host.}

\PYG{+w}{    }\PYG{k+kt}{uint2}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{hostCoordinates}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Obstacle coordinates are put here first, then copied to the GPU.}
\PYG{+w}{    }\PYG{n}{FindBoundaryCells}\PYG{p}{(}\PYG{n}{hostFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hostCoordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{numFluidCells}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{CountFluidCells}\PYG{p}{(}\PYG{n}{hostFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{cudaMalloc}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{devCoordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{k+kt}{uint2}\PYG{p}{));}

\PYG{+w}{    }\PYG{n}{cudaMemcpy}\PYG{p}{(}\PYG{n}{devCoordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hostCoordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{k+kt}{uint2}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{cudaMemcpyHostToDevice}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Copy the flags and coordinates arrays to the device.}
\PYG{+w}{    }\PYG{n}{CopyFieldToDevice}\PYG{p}{(}\PYG{n}{devFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hostFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{FreeMatrix}\PYG{p}{(}\PYG{n}{hostFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{delete}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{hostCoordinates}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{PerformSetup}\PYG{p}{()}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{cudaGetDeviceProperties}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{deviceProperties}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{SetBlockDimensions}\PYG{p}{();}

\PYG{+w}{    }\PYG{n}{streams}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{cudaStream\PYGZus{}t}\PYG{p}{[}\PYG{n}{totalStreams}\PYG{p}{];}
\PYG{+w}{    }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{totalStreams}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{++}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{cudaStreamCreate}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{streams}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]);}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n}{delX}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{width}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{delY}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{height}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{Timestep}\PYG{p}{(}\PYG{n}{REAL}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{simulationTime}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{hostTimestep}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{nullptr}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Set heap or global mem pointers to nullptr so freeing has no effect and only free label is needed.}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{nullptr}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{gamma}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{nullptr}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{pressureResidualNorm}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{pressureIterations}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n+nf}{numBlocksForStreamCalc}\PYG{p}{(}\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{));}

\PYG{+w}{    }\PYG{c+c1}{// Perform computations}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{SetBoundaryConditions}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{devFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{devCoordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{inflowVelocity}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{surfaceFrictionalPermissibility}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Illegal address}

\PYG{+w}{    }\PYG{n}{cudaMalloc}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{));}\PYG{+w}{ }\PYG{c+c1}{// Allocate a new device variable for timestep}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ComputeTimestep}\PYG{p}{(}\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{reynoldsNo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{timeStepSafetyFactor}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{hostTimestep}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{n}{REAL}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Copy the device timestep so it can be added to simulation time}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{cudaMemcpyAsync}\PYG{p}{(}\PYG{n}{hostTimestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{cudaMemcpyDeviceToHost}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{n}{computationStreams}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{cudaMalloc}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{))}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Allocate gamma on the device and then calculate it}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ComputeGamma}\PYG{p}{(}\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{.}\PYG{n}{y}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ComputeFG}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{devFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{bodyForces}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{bodyForces}\PYG{p}{.}\PYG{n}{y}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{gamma}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{reynoldsNo}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{n}{ComputeRHS}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocks}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{RHS}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{devFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// ComputeRHS is simple enough not to need a wrapper}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{cudaStreamSynchronize}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Need to synchronise because pressure depends on RHS.}

\PYG{+w}{    }\PYG{n}{pressureIterations}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{Poisson}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{RHS}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{devFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{devCoordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{numFluidCells}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{numColoursSOR}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{pressureResidualTolerance}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{pressureMinIterations}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{pressureMaxIterations}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{.}\PYG{n}{relaxationParameter}\PYG{p}{,}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{n}{pressureResidualNorm}\PYG{p}{);}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{pressureIterations}\PYG{+w}{ }\PYG{o}{==}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Here 0 is the error case.}

\PYG{+w}{    }\PYG{n}{printf}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}Number of iterations: \PYGZpc{}i, residual norm: \PYGZpc{}f.}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressureIterations}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressureResidualNorm}\PYG{p}{);}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{n}{cudaMemcpy2DAsync}\PYG{p}{(}\PYG{n}{copiedPressure}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{cudaMemcpyDeviceToHost}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{n}{computationStreams}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{]);}\PYG{+w}{ }\PYG{c+c1}{// Pressure is unchanged after this point, so can copy it async}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ComputeVelocities}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{devFlags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{goto}\PYG{+w}{ }\PYG{n}{free}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{cudaMemcpy2DAsync}\PYG{p}{(}\PYG{n}{copiedHVel}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{cudaMemcpyDeviceToHost}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{n}{computationStreams}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{]);}\PYG{+w}{ }\PYG{c+c1}{// Velocities are unchanged after this point, copy them}
\PYG{+w}{    }\PYG{n}{cudaMemcpy2DAsync}\PYG{p}{(}\PYG{n}{copiedVVel}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{cudaMemcpyDeviceToHost}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{n}{computationStreams}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{]);}

\PYG{+w}{    }\PYG{n}{ComputeStream}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksForStreamCalc}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{cudaMemcpy2DAsync}\PYG{p}{(}\PYG{n}{copiedStream}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{n}{REAL}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{cudaMemcpyDeviceToHost}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{n}{computationStreams}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{3}\PYG{p}{]);}\PYG{+w}{ }\PYG{c+c1}{// Stream function is the last to be calculated, copy it once it is ready.}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+c1}{// Resize all of the fields for transmission.}
\PYG{+w}{    }\PYG{n}{ResizeField}\PYG{p}{(}\PYG{n}{copiedHVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{transmissionHVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{ResizeField}\PYG{p}{(}\PYG{n}{copiedVVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{transmissionVVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{ResizeField}\PYG{p}{(}\PYG{n}{copiedPressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{transmissionPressure}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{ResizeField}\PYG{p}{(}\PYG{n}{copiedStream}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{transmissionStream}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{simulationTime}\PYG{+w}{ }\PYG{o}{+=}\PYG{+w}{ }\PYG{o}{*}\PYG{n}{hostTimestep}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Only add to the simulation time if the timestep was successful. Error case is therefore simulationTime unchanged after Timestep returns.}


\PYG{n+nl}{free}\PYG{p}{:}\PYG{+w}{ }\PYG{c+c1}{// Pointers that need to be freed even if timestep is unsuccessful.}
\PYG{+w}{    }\PYG{n}{delete}\PYG{+w}{ }\PYG{n}{hostTimestep}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{timestep}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{cudaFree}\PYG{p}{(}\PYG{n}{gamma}\PYG{p}{);}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{bool}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{o}{::}\PYG{n}{IsDeviceSupported}\PYG{p}{()}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{count}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{cudaGetDeviceCount}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{count}\PYG{p}{);}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{count}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{cudaDeviceProp}\PYG{+w}{ }\PYG{n}{properties}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{cudaGetDeviceProperties}\PYG{p}{(}\PYG{o}{\PYGZam{}}\PYG{n}{properties}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{);}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{properties}\PYG{p}{.}\PYG{n}{major}\PYG{+w}{ }\PYG{o}{\PYGZgt{}=}\PYG{+w}{ }\PYG{n}{GPU\PYGZus{}MIN\PYGZus{}MAJOR\PYGZus{}VERSION}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{return}\PYG{+w}{ }\PYG{n+nb}{true}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n+nb}{false}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}
\end{Verbatim}

\begin{Verbatim}[commandchars=\\\{\}]
\PYG{c+c1}{//\PYGZsh{}define HOLLOW\PYGZus{}TRIANGLES}

\PYG{k}{using}\PYG{+w}{ }\PYG{n+nn}{OpenTK.Graphics.OpenGL4}\PYG{p}{;}
\PYG{k}{using}\PYG{+w}{ }\PYG{n+nn}{OpenTK.Wpf}\PYG{p}{;}
\PYG{k}{using}\PYG{+w}{ }\PYG{n+nn}{System}\PYG{p}{;}
\PYG{k}{using}\PYG{+w}{ }\PYG{n+nn}{System.ComponentModel}\PYG{p}{;}
\PYG{k}{using}\PYG{+w}{ }\PYG{n+nn}{System.Diagnostics}\PYG{p}{;}
\PYG{k}{using}\PYG{+w}{ }\PYG{n+nn}{System.Windows.Controls}\PYG{p}{;}
\PYG{k}{using}\PYG{+w}{ }\PYG{n+nn}{UserInterface.HelperClasses}\PYG{p}{;}
\PYG{k}{using}\PYG{+w}{ }\PYG{n+nn}{Visualisation}\PYG{p}{;}

\PYG{k}{namespace}\PYG{+w}{ }\PYG{n+nn}{UserInterface}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{c+c1}{/// \PYGZlt{}summary\PYGZgt{}}
\PYG{+w}{    }\PYG{c+c1}{/// Interaction logic for VisualisationControl.xaml}
\PYG{+w}{    }\PYG{c+c1}{/// \PYGZlt{}/summary\PYGZgt{}}
\PYG{+w}{    }\PYG{k}{public}\PYG{+w}{ }\PYG{k}{partial}\PYG{+w}{ }\PYG{k}{class}\PYG{+w}{ }\PYG{n+nc}{VisualisationControl}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{UserControl}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{INotifyPropertyChanged}
\PYG{+w}{    }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k}{readonly}\PYG{+w}{ }\PYG{n}{ShaderManager}\PYG{+w}{ }\PYG{n}{fieldShaderManager}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k}{readonly}\PYG{+w}{ }\PYG{n}{ShaderManager}\PYG{+w}{ }\PYG{n}{contourShaderManager}\PYG{p}{;}
\PYG{+w}{        }\PYG{c+c1}{//private ComputeShaderManager computeShaderManager;}

\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k}{readonly}\PYG{+w}{ }\PYG{k+kt}{float}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{vertices}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k}{readonly}\PYG{+w}{ }\PYG{k+kt}{uint}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{fieldIndices}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{uint}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{contourIndices}\PYG{p}{;}

\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k}{const}\PYG{+w}{ }\PYG{k+kt}{uint}\PYG{+w}{ }\PYG{n}{primitiveRestartIndex}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kt}{uint}\PYG{p}{.}\PYG{n}{MaxValue}\PYG{p}{;}

\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{hVBO}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{hFieldVAO}\PYG{p}{;}
\PYG{+w}{        }\PYG{c+c1}{//private int hFieldEBO;}

\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{hContourVAO}\PYG{p}{;}
\PYG{+w}{        }\PYG{c+c1}{//private int hContourEBO;}

\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{hSubtrahend}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{hScalar}\PYG{p}{;}

\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{n}{ParameterHolder}\PYG{+w}{ }\PYG{n}{parameterHolder}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{float}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{;}

\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{dataWidth}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{dataHeight}\PYG{p}{;}

\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k+kt}{float}\PYG{+w}{ }\PYG{n}{frameTime}\PYG{p}{;}

\PYG{+w}{        }\PYG{k}{public}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{DataWidth}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{k}{get}\PYG{+w}{ }\PYG{o}{=\PYGZgt{}}\PYG{+w}{ }\PYG{n}{dataWidth}\PYG{p}{;}\PYG{+w}{ }\PYG{k}{set}\PYG{+w}{ }\PYG{o}{=\PYGZgt{}}\PYG{+w}{ }\PYG{n}{dataWidth}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{value}\PYG{p}{;}\PYG{+w}{ }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{public}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{DataHeight}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{k}{get}\PYG{+w}{ }\PYG{o}{=\PYGZgt{}}\PYG{+w}{ }\PYG{n}{dataHeight}\PYG{p}{;}\PYG{+w}{ }\PYG{k}{set}\PYG{+w}{ }\PYG{o}{=\PYGZgt{}}\PYG{+w}{ }\PYG{n}{dataHeight}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{value}\PYG{p}{;}\PYG{+w}{ }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{public}\PYG{+w}{ }\PYG{k+kt}{float}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{StreamFunction}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{k}{get}\PYG{+w}{ }\PYG{o}{=\PYGZgt{}}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{;}\PYG{+w}{ }\PYG{k}{set}\PYG{+w}{ }\PYG{o}{=\PYGZgt{}}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{value}\PYG{p}{;}\PYG{+w}{ }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{public}\PYG{+w}{ }\PYG{k+kt}{float}\PYG{+w}{ }\PYG{n}{FrameTime}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{k}{get}\PYG{+w}{ }\PYG{o}{=\PYGZgt{}}\PYG{+w}{ }\PYG{n}{frameTime}\PYG{p}{;}\PYG{+w}{ }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{k}{public}\PYG{+w}{ }\PYG{k}{event}\PYG{+w}{ }\PYG{n}{PropertyChangedEventHandler}\PYG{o}{?}\PYG{+w}{ }\PYG{n}{PropertyChanged}\PYG{p}{;}

\PYG{+w}{        }\PYG{k}{public}\PYG{+w}{ }\PYG{n+nf}{VisualisationControl}\PYG{p}{(}\PYG{n}{ParameterHolder}\PYG{+w}{ }\PYG{n}{parameterHolder}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{float}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{dataWidth}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{dataHeight}\PYG{p}{)}
\PYG{+w}{        }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n}{parameterHolder}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{parameterHolder}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n}{streamFunction}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n}{dataWidth}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{dataWidth}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n}{dataHeight}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{dataHeight}\PYG{p}{;}

\PYG{+w}{            }\PYG{n}{InitializeComponent}\PYG{p}{();}
\PYG{+w}{            }\PYG{n}{DataContext}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{;}

\PYG{+w}{            }\PYG{n}{SetUpGL}\PYG{p}{(}\PYG{k}{out}\PYG{+w}{ }\PYG{n}{fieldShaderManager}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{n}{contourShaderManager}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{n}{vertices}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{n}{fieldIndices}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{n}{contourIndices}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Using out parameters so that these can be returned to the control of the constructor and not generate warnings}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{o}{\PYGZti{}}\PYG{n}{VisualisationControl}\PYG{p}{()}
\PYG{+w}{        }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{fieldShaderManager}\PYG{p}{.}\PYG{n}{Dispose}\PYG{p}{();}
\PYG{+w}{            }\PYG{n}{contourShaderManager}\PYG{p}{.}\PYG{n}{Dispose}\PYG{p}{();}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}


\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k}{void}\PYG{+w}{ }\PYG{n+nf}{SetUpGL}\PYG{p}{(}\PYG{k}{out}\PYG{+w}{ }\PYG{n}{ShaderManager}\PYG{+w}{ }\PYG{n}{fieldShaderManager}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{n}{ShaderManager}\PYG{+w}{ }\PYG{n}{contourShaderManager}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{k+kt}{float}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{vertices}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{k+kt}{uint}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{fieldIndices}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{k+kt}{uint}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{contourIndices}\PYG{p}{)}
\PYG{+w}{        }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{GLWpfControlSettings}\PYG{+w}{ }\PYG{n}{settings}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{p}{()}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{n}{MajorVersion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m}{3}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{MinorVersion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m}{1}\PYG{+w}{ }\PYG{p}{\PYGZcb{};}
\PYG{+w}{            }\PYG{n}{GLControl}\PYG{p}{.}\PYG{n}{Start}\PYG{p}{(}\PYG{n}{settings}\PYG{p}{);}

\PYG{+w}{            }\PYG{n}{fieldShaderManager}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ShaderManager}\PYG{p}{([(}\PYG{l+s}{\PYGZdq{}fieldShader.frag\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{ShaderType}\PYG{p}{.}\PYG{n}{FragmentShader}\PYG{p}{),}\PYG{+w}{ }\PYG{p}{(}\PYG{l+s}{\PYGZdq{}fieldShader.vert\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{ShaderType}\PYG{p}{.}\PYG{n}{VertexShader}\PYG{p}{)]);}
\PYG{+w}{            }\PYG{n}{contourShaderManager}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ShaderManager}\PYG{p}{([(}\PYG{l+s}{\PYGZdq{}contourShader.frag\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{ShaderType}\PYG{p}{.}\PYG{n}{FragmentShader}\PYG{p}{),}\PYG{+w}{ }\PYG{p}{(}\PYG{l+s}{\PYGZdq{}contourShader.vert\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{ShaderType}\PYG{p}{.}\PYG{n}{VertexShader}\PYG{p}{)]);}
\PYG{+w}{            }\PYG{c+c1}{//computeShaderManager = new ComputeShaderManager(\PYGZdq{}shader.comp\PYGZdq{});}

\PYG{+w}{            }\PYG{n}{GL}\PYG{p}{.}\PYG{n}{Enable}\PYG{p}{(}\PYG{n}{EnableCap}\PYG{p}{.}\PYG{n}{PrimitiveRestart}\PYG{p}{);}
\PYG{+w}{            }\PYG{n}{GL}\PYG{p}{.}\PYG{n}{PrimitiveRestartIndex}\PYG{p}{(}\PYG{n}{primitiveRestartIndex}\PYG{p}{);}

\PYG{+w}{            }\PYG{n}{HandleData}\PYG{p}{(}\PYG{k}{out}\PYG{+w}{ }\PYG{n}{vertices}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{n}{fieldIndices}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{n}{contourIndices}\PYG{p}{);}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{k}{private}\PYG{+w}{ }\PYG{k}{void}\PYG{+w}{ }\PYG{n+nf}{HandleData}\PYG{p}{(}\PYG{k}{out}\PYG{+w}{ }\PYG{k+kt}{float}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{vertices}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{k+kt}{uint}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{fieldIndices}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{out}\PYG{+w}{ }\PYG{k+kt}{uint}\PYG{p}{[]}\PYG{+w}{ }\PYG{n}{contourIndices}\PYG{p}{)}
\PYG{+w}{        }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{//GL.ClearColor(0.1f, 0.7f, 0.5f, 1.0f);}

\PYG{+w}{            }\PYG{n}{vertices}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{FillVertices}\PYG{p}{(}\PYG{n}{dataWidth}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dataHeight}\PYG{p}{);}
\PYG{+w}{            }\PYG{n}{fieldIndices}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{FillIndices}\PYG{p}{(}\PYG{n}{dataWidth}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dataHeight}\PYG{p}{);}
\PYG{+w}{            }\PYG{n}{contourIndices}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{FindContourIndices}\PYG{p}{(}\PYG{n}{streamFunction}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameterHolder}\PYG{p}{.}\PYG{n}{ContourTolerance}\PYG{p}{.}\PYG{n}{Value}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameterHolder}\PYG{p}{.}\PYG{n}{ContourSpacing}\PYG{p}{.}\PYG{n}{Value}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{primitiveRestartIndex}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dataWidth}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dataHeight}\PYG{p}{);}

\PYG{+w}{            }\PYG{n}{FieldParameters}\PYG{+w}{ }\PYG{n}{fieldParameters}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{parameterHolder}\PYG{p}{.}\PYG{n}{FieldParameters}\PYG{p}{.}\PYG{n}{Value}\PYG{p}{;}

\PYG{+w}{            }\PYG{c+c1}{// Setting up data for field visualisation}
\PYG{+w}{            }\PYG{n}{hFieldVAO}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{CreateVAO}\PYG{p}{();}
\PYG{+w}{            }\PYG{n}{hVBO}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{CreateVBO}\PYG{p}{(}\PYG{n}{vertices}\PYG{p}{.}\PYG{n}{Length}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{fieldParameters}\PYG{p}{.}\PYG{n}{field}\PYG{p}{.}\PYG{n}{Length}\PYG{p}{);}

\PYG{+w}{            }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{BufferSubData}\PYG{p}{(}\PYG{n}{vertices}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{0}\PYG{p}{);}
\PYG{+w}{            }\PYG{c+c1}{//Trace.WriteLine(GL.GetError().ToString());}
\PYG{+w}{            }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{BufferSubData}\PYG{p}{(}\PYG{n}{fieldParameters}\PYG{p}{.}\PYG{n}{field}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vertices}\PYG{p}{.}\PYG{n}{Length}\PYG{p}{);}
\PYG{+w}{            }\PYG{c+c1}{//Trace.WriteLine(GL.GetError().ToString());}

\PYG{+w}{            }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{CreateAttribPointer}\PYG{p}{(}\PYG{l+m}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{0}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Vertex pointer}
\PYG{+w}{            }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{CreateAttribPointer}\PYG{p}{(}\PYG{l+m}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vertices}\PYG{p}{.}\PYG{n}{Length}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Field value pointer}

\PYG{+w}{            }\PYG{n}{\PYGZus{}}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{CreateEBO}\PYG{p}{(}\PYG{n}{fieldIndices}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// EBO handle is never used because it is bound to the VAO}

\PYG{+w}{            }\PYG{c+c1}{// Setting up data for contour line plotting}
\PYG{+w}{            }\PYG{n}{hContourVAO}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{CreateVAO}\PYG{p}{();}
\PYG{+w}{            }\PYG{n}{GL}\PYG{p}{.}\PYG{n}{BindBuffer}\PYG{p}{(}\PYG{n}{BufferTarget}\PYG{p}{.}\PYG{n}{ArrayBuffer}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVBO}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Bind the same VBO}

\PYG{+w}{            }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{CreateAttribPointer}\PYG{p}{(}\PYG{l+m}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{0}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// And the same for attribute pointers}
\PYG{+w}{            }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{CreateAttribPointer}\PYG{p}{(}\PYG{l+m}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vertices}\PYG{p}{.}\PYG{n}{Length}\PYG{p}{);}

\PYG{+w}{            }\PYG{n}{\PYGZus{}}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{CreateEBO}\PYG{p}{(}\PYG{n}{contourIndices}\PYG{p}{);}

\PYG{+w}{            }\PYG{c+c1}{// Return to field context}
\PYG{+w}{            }\PYG{n}{GL}\PYG{p}{.}\PYG{n}{BindVertexArray}\PYG{p}{(}\PYG{n}{hFieldVAO}\PYG{p}{);}

\PYG{+w}{            }\PYG{n}{hSubtrahend}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{fieldShaderManager}\PYG{p}{.}\PYG{n}{GetUniformLocation}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}subtrahend\PYGZdq{}}\PYG{p}{);}
\PYG{+w}{            }\PYG{n}{hScalar}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{fieldShaderManager}\PYG{p}{.}\PYG{n}{GetUniformLocation}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}scalar\PYGZdq{}}\PYG{p}{);}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{k}{public}\PYG{+w}{ }\PYG{k}{void}\PYG{+w}{ }\PYG{n+nf}{GLControl\PYGZus{}OnRender}\PYG{p}{(}\PYG{n}{TimeSpan}\PYG{+w}{ }\PYG{n}{delta}\PYG{p}{)}
\PYG{+w}{        }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{GL}\PYG{p}{.}\PYG{n}{Clear}\PYG{p}{(}\PYG{n}{ClearBufferMask}\PYG{p}{.}\PYG{n}{ColorBufferBit}\PYG{p}{);}
\PYG{+w}{            }\PYG{n}{FieldParameters}\PYG{+w}{ }\PYG{n}{fieldParameters}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{parameterHolder}\PYG{p}{.}\PYG{n}{FieldParameters}\PYG{p}{.}\PYG{n}{Value}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Get the most recent field parameters}

\PYG{+w}{            }\PYG{c+c1}{// For each draw command, need to bind the program, set uniforms, bind VAO, draw}

\PYG{+w}{            }\PYG{c+c1}{// Drawing field value spectrum}
\PYG{+w}{            }\PYG{n}{fieldShaderManager}\PYG{p}{.}\PYG{n}{Use}\PYG{p}{();}

\PYG{+w}{            }\PYG{n}{fieldShaderManager}\PYG{p}{.}\PYG{n}{SetUniform}\PYG{p}{(}\PYG{n}{hSubtrahend}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{fieldParameters}\PYG{p}{.}\PYG{n}{min}\PYG{p}{);}
\PYG{+w}{            }\PYG{n}{fieldShaderManager}\PYG{p}{.}\PYG{n}{SetUniform}\PYG{p}{(}\PYG{n}{hScalar}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m}{1}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{fieldParameters}\PYG{p}{.}\PYG{n}{max}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{fieldParameters}\PYG{p}{.}\PYG{n}{min}\PYG{p}{));}

\PYG{+w}{            }\PYG{n}{GL}\PYG{p}{.}\PYG{n}{BindVertexArray}\PYG{p}{(}\PYG{n}{hFieldVAO}\PYG{p}{);}
\PYG{+w}{            }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{BufferSubData}\PYG{p}{(}\PYG{n}{fieldParameters}\PYG{p}{.}\PYG{n}{field}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vertices}\PYG{p}{.}\PYG{n}{Length}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Update the field values}

\PYG{c+cp}{\PYGZsh{}if HOLLOW\PYGZus{}TRIANGLES}
\PYG{+w}{            }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{Draw}\PYG{p}{(}\PYG{n}{fieldIndices}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PrimitiveType}\PYG{p}{.}\PYG{n}{LineStrip}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// For alignment testing \PYGZhy{} don\PYGZsq{}t fill in triangles.}
\PYG{c+cp}{\PYGZsh{}else}
\PYG{+w}{            }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{Draw}\PYG{p}{(}\PYG{n}{fieldIndices}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PrimitiveType}\PYG{p}{.}\PYG{n}{Triangles}\PYG{p}{);}
\PYG{c+cp}{\PYGZsh{}endif}

\PYG{+w}{            }\PYG{c+c1}{// Drawing contour lines over the top}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{parameterHolder}\PYG{p}{.}\PYG{n}{DrawContours}\PYG{p}{.}\PYG{n}{Value}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{contourIndices}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{FindContourIndices}\PYG{p}{(}\PYG{n}{streamFunction}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameterHolder}\PYG{p}{.}\PYG{n}{ContourTolerance}\PYG{p}{.}\PYG{n}{Value}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parameterHolder}\PYG{p}{.}\PYG{n}{ContourSpacing}\PYG{p}{.}\PYG{n}{Value}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{primitiveRestartIndex}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dataWidth}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dataHeight}\PYG{p}{);}
\PYG{+w}{                }\PYG{n}{contourShaderManager}\PYG{p}{.}\PYG{n}{Use}\PYG{p}{();}

\PYG{+w}{                }\PYG{n}{GL}\PYG{p}{.}\PYG{n}{BindVertexArray}\PYG{p}{(}\PYG{n}{hContourVAO}\PYG{p}{);}

\PYG{+w}{                }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{UpdateEBO}\PYG{p}{(}\PYG{n}{contourIndices}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{BufferUsageHint}\PYG{p}{.}\PYG{n}{DynamicDraw}\PYG{p}{);}

\PYG{+w}{                }\PYG{n}{GLHelper}\PYG{p}{.}\PYG{n}{Draw}\PYG{p}{(}\PYG{n}{contourIndices}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PrimitiveType}\PYG{p}{.}\PYG{n}{LineStrip}\PYG{p}{);}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}

\PYG{+w}{            }\PYG{n}{frameTime}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{float}\PYG{p}{)}\PYG{n}{delta}\PYG{p}{.}\PYG{n}{TotalSeconds}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{PropertyChanged}\PYG{o}{?.}\PYG{n}{Invoke}\PYG{p}{(}\PYG{k}{this}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{PropertyChangedEventArgs}\PYG{p}{(}\PYG{n}{nameof}\PYG{p}{(}\PYG{n}{FrameTime}\PYG{p}{)));}

\PYG{+w}{            }\PYG{n}{ErrorCode}\PYG{+w}{ }\PYG{n}{errorCode}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{GL}\PYG{p}{.}\PYG{n}{GetError}\PYG{p}{();}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{errorCode}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{ErrorCode}\PYG{p}{.}\PYG{n}{NoError}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{Trace}\PYG{p}{.}\PYG{n}{WriteLine}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}\PYGZbs{}x1B[31m\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{errorCode}\PYG{p}{.}\PYG{n}{ToString}\PYG{p}{()}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}\PYGZbs{}033[0m\PYGZdq{}}\PYG{p}{);}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}
\end{Verbatim}

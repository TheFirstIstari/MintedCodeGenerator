\begin{Verbatim}[commandchars=\\\{\}]
\PYG{c+cp}{\PYGZsh{}ifndef GPUSOLVER\PYGZus{}CUH}
\PYG{c+cp}{\PYGZsh{}define GPUSOLVER\PYGZus{}CUH}

\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}Definitions.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}Solver.h\PYGZdq{}}

\PYG{n}{constexpr}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{computationStreams}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{4}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Number of streams for launching parallelisable computation kernels}
\PYG{n}{constexpr}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{memcpyStreams}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{4}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Number of streams for launching parallel memory copies}
\PYG{n}{constexpr}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{totalStreams}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{computationStreams}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{memcpyStreams}\PYG{p}{;}

\PYG{n}{class}\PYG{+w}{ }\PYG{n}{GPUSolver}\PYG{+w}{ }\PYG{o}{:}
\PYG{+w}{    }\PYG{n}{public}\PYG{+w}{ }\PYG{n}{Solver}
\PYG{p}{\PYGZob{}}
\PYG{n}{private}\PYG{o}{:}
\PYG{+w}{    }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Horizontal velocity, resides on device.}
\PYG{+w}{    }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Vertical velocity, resides on device.}
\PYG{+w}{    }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pressure}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Pressure, resides on device.}
\PYG{+w}{    }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{RHS}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Pressure equation RHS, resides on device.}
\PYG{+w}{    }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{streamFunction}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Stream function, resides on device.}
\PYG{+w}{    }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{F}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Quantity F, resides on device.}
\PYG{+w}{    }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{G}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Quantity G, resides on device.}
\PYG{+w}{    }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{devFlags}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Cell flags, resides on device.}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{transmissionHVel}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{transmissionVVel}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{transmissionPressure}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{transmissionStream}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{copiedHVel}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{copiedVVel}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{copiedPressure}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{copiedStream}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delX}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Step size in x direction, resides on host.}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{delY}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Step size in y direction, resides on host.}
\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{timestep}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Timestep, resides on device.}

\PYG{+w}{    }\PYG{k+kt}{uint2}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{devCoordinates}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Array of obstacle coordinates, resides on device.}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Length of coordinates array}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numFluidCells}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{const}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numColoursSOR}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{;}

\PYG{+w}{    }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n}{numBlocks}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Number of blocks for a grid of iMax x jMax threads.}
\PYG{+w}{    }\PYG{k+kt}{dim3}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Maximum number of threads per block in a 2D square allocation.}

\PYG{+w}{    }\PYG{k+kt}{bool}\PYG{o}{**}\PYG{+w}{ }\PYG{n}{obstacles}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// 2D array of obstacles, resides on host.}

\PYG{+w}{    }\PYG{n}{cudaDeviceProp}\PYG{+w}{ }\PYG{n}{deviceProperties}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{cudaStream\PYGZus{}t}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Streams that can be used. First are the computation streams (0 to the number of computation streams), then are memcpy streams. To access memcpy streams, first add computationStreams as an offset}

\PYG{+w}{    }\PYG{n}{template}\PYG{o}{\PYGZlt{}}\PYG{n}{typename}\PYG{+w}{ }\PYG{n}{T}\PYG{o}{\PYGZgt{}}
\PYG{+w}{    }\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{CopyFieldToDevice}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{T}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{devField}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{T}\PYG{o}{**}\PYG{+w}{ }\PYG{n}{hostField}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{template}\PYG{o}{\PYGZlt{}}\PYG{n}{typename}\PYG{+w}{ }\PYG{n}{T}\PYG{o}{\PYGZgt{}}
\PYG{+w}{    }\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{CopyFieldToHost}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{T}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{devField}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{T}\PYG{o}{**}\PYG{+w}{ }\PYG{n}{hostField}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{);}

\PYG{+w}{    }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{SetBlockDimensions}\PYG{p}{();}

\PYG{+w}{    }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{ResizeField}\PYG{p}{(}\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{enlargedField}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{enlargedXLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{enlargedYLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xOffset}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yOffset}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{transmissionField}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{xLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{yLength}\PYG{p}{);}

\PYG{n}{public}\PYG{o}{:}
\PYG{+w}{    }\PYG{n}{GPUSolver}\PYG{p}{(}\PYG{n}{SimulationParameters}\PYG{+w}{ }\PYG{n}{parameters}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}

\PYG{+w}{    }\PYG{o}{\PYGZti{}}\PYG{n}{GPUSolver}\PYG{p}{();}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n+nf}{GetHorizontalVelocity}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n+nf}{GetVerticalVelocity}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n+nf}{GetPressure}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{o}{*}\PYG{+w}{ }\PYG{n+nf}{GetStreamFunction}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{p}{;}

\PYG{+w}{    }\PYG{k+kt}{bool}\PYG{o}{**}\PYG{+w}{ }\PYG{n+nf}{GetObstacles}\PYG{p}{()}\PYG{+w}{ }\PYG{k}{const}\PYG{p}{;}

\PYG{+w}{    }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{ProcessObstacles}\PYG{p}{();}

\PYG{+w}{    }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{PerformSetup}\PYG{p}{();}

\PYG{+w}{    }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{Timestep}\PYG{p}{(}\PYG{n}{REAL}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{simulationTime}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Implementing abstract inherited method}

\PYG{+w}{    }\PYG{k}{static}\PYG{+w}{ }\PYG{k+kt}{bool}\PYG{+w}{ }\PYG{n+nf}{IsDeviceSupported}\PYG{p}{();}
\PYG{p}{\PYGZcb{};}

\PYG{c+cp}{\PYGZsh{}endif }\PYG{c+c1}{// !GPUSOLVER\PYGZus{}CUH}
\end{Verbatim}

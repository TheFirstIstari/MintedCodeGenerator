\begin{Verbatim}[commandchars=\\\{\}]
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZdq{}Boundary.cuh\PYGZdq{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZlt{}cmath\PYGZgt{}}
\PYG{c+cp}{\PYGZsh{}include}\PYG{+w}{ }\PYG{c+cpf}{\PYGZlt{}vector\PYGZgt{}}

\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{SetFlags}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{k+kt}{bool}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{obstacles}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{BYTE}\PYG{p}{)}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZlt{}\PYGZlt{}}\PYG{+w}{ }\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{BYTE}\PYG{p}{)}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZlt{}\PYGZlt{}}\PYG{+w}{ }\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{BYTE}\PYG{p}{)}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZlt{}\PYGZlt{}}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{((}\PYG{n}{BYTE}\PYG{p}{)}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZlt{}\PYGZlt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{BYTE}\PYG{p}{)}\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{obstacles}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{rowNum}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{colNum}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{//5 bits in the format: self, north, east, south, west.}
\PYG{p}{\PYGZcb{}}

\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{TopBoundary}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{index}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{index}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Copy hVel from the cell below}
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Set vVel along the top to 0}
\PYG{p}{\PYGZcb{}}

\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{BottomBoundary}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{index}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{index}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Copy hVel from the cell above}
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Set vVel along the bottom to 0}
\PYG{p}{\PYGZcb{}}

\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{LeftBoundary}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{inflowVelocity}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{index}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{index}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{inflowVelocity}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Set hVel to inflow velocity on left boundary}
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Set vVel to 0}
\PYG{p}{\PYGZcb{}}

\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{RightBoundary}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}
\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{index}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{index}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Copy the velocity values from the previous cell (mass flows out at the boundary)}
\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{index}\PYG{p}{);}
\PYG{p}{\PYGZcb{}}

\PYG{k+kr}{\PYGZus{}\PYGZus{}global\PYGZus{}\PYGZus{}}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{ObstacleBoundary}\PYG{p}{(}\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{uint2}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{chi}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{index}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n+nb}{blockIdx}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n+nb}{blockDim}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n+nb}{threadIdx}\PYG{p}{.}\PYG{n}{x}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{index}\PYG{+w}{ }\PYG{o}{\PYGZgt{}=}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{    }
\PYG{+w}{    }\PYG{k+kt}{uint2}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{[}\PYG{n}{index}\PYG{p}{];}

\PYG{+w}{    }\PYG{n}{BYTE}\PYG{+w}{ }\PYG{n}{flag}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{B\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{flags}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{);}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{northBit}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{flag}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{NORTH}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{NORTHSHIFT}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{eastBit}\PYG{+w}{  }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{flag}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{EAST}\PYG{p}{)}\PYG{+w}{  }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{EASTSHIFT}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{southBit}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{flag}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{SOUTH}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{SOUTHSHIFT}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{westBit}\PYG{+w}{  }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{flag}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{WEST}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}\PYGZgt{}}\PYG{+w}{ }\PYG{n}{WESTSHIFT}\PYG{p}{;}

\PYG{+w}{    }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{velocityModifier}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{chi}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// This converts chi from chi in [0,1] to in [\PYGZhy{}1,1]}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{eastBit}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// If the cell is an eastern boudary, hVel is 0}
\PYG{+w}{        }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{northBit}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{velocityModifier}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// For northern boundaries, use the horizontal velocity above...}
\PYG{+w}{            }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{southBit}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{velocityModifier}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{));}\PYG{+w}{ }\PYG{c+c1}{// ...and for southern boundaries, use the horizontal velocity below.}

\PYG{+w}{    }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{northBit}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// If the cell is a northern boundary, vVel is 0}
\PYG{+w}{        }\PYG{o}{*}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{eastBit}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{velocityModifier}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{)}\PYG{+w}{ }\PYG{c+c1}{// For eastern boundaries, use the vertical velocity to the right...}
\PYG{+w}{            }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{westBit}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{velocityModifier}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{));}\PYG{+w}{ }\PYG{c+c1}{// ...and for western boundaries, use the vertical velocity to the left.}

\PYG{+w}{    }\PYG{c+c1}{// The following lines are unavoidable branches.}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{southBit}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{c+c1}{// If south bit is set,...}
\PYG{+w}{        }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// ...then set the velocity coming into the boundary to 0.}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{westBit}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{c+c1}{// If west bit is set,...}
\PYG{+w}{        }\PYG{n}{F\PYGZus{}PITCHACCESS}\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{ptr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{.}\PYG{n}{pitch}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// ...then set the velocity coming into the boundary to 0.}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}

\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{SetBoundaryConditions}\PYG{p}{(}\PYG{n}{cudaStream\PYGZus{}t}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{REAL}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{PointerWithPitch}\PYG{o}{\PYGZlt{}}\PYG{n}{BYTE}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{uint2}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{inflowVelocity}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{REAL}\PYG{+w}{ }\PYG{n}{chi}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numBlocksTopBottom}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{);}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numBlocksLeftRight}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{);}
\PYG{+w}{    }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numBlocksObstacle}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{INT\PYGZus{}DIVIDE\PYGZus{}ROUND\PYGZus{}UP}\PYG{p}{(}\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{);}

\PYG{+w}{    }\PYG{k+kt}{uint2}\PYG{o}{*}\PYG{+w}{ }\PYG{n}{testingCoordinates}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{k+kt}{uint2}\PYG{p}{[}\PYG{n}{coordinatesLength}\PYG{p}{];}
\PYG{+w}{    }\PYG{n}{cudaMemcpy}\PYG{p}{(}\PYG{n}{testingCoordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{+w}{ }\PYG{o}{*}\PYG{+w}{ }\PYG{k}{sizeof}\PYG{p}{(}\PYG{k+kt}{uint2}\PYG{p}{),}\PYG{+w}{ }\PYG{n}{cudaMemcpyDeviceToHost}\PYG{p}{);}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{n}{TopBoundary}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksTopBottom}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{BottomBoundary}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksTopBottom}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{LeftBoundary}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksLeftRight}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{inflowVelocity}\PYG{p}{);}
\PYG{+w}{    }\PYG{n}{RightBoundary}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksLeftRight}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{);}

\PYG{+w}{    }\PYG{n}{cudaError\PYGZus{}t}\PYG{+w}{ }\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cudaStreamSynchronize}\PYG{p}{(}\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]);}
\PYG{+w}{    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{retVal}\PYG{+w}{ }\PYG{o}{!=}\PYG{+w}{ }\PYG{n}{cudaSuccess}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{retVal}\PYG{p}{;}
\PYG{+w}{    }\PYG{n}{ObstacleBoundary}\PYG{+w}{ }\PYG{n+nf}{KERNEL\PYGZus{}ARGS}\PYG{p}{(}\PYG{n}{numBlocksObstacle}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{threadsPerBlock}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{streams}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{])}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{hVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{vVel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{chi}\PYG{p}{);}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{cudaDeviceSynchronize}\PYG{p}{();}
\PYG{p}{\PYGZcb{}}

\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n}{FindBoundaryCells}\PYG{p}{(}\PYG{n}{BYTE}\PYG{o}{**}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{uint2}\PYG{o}{*\PYGZam{}}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{coordinatesLength}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n}{std}\PYG{o}{::}\PYG{n}{vector}\PYG{o}{\PYGZlt{}}\PYG{k+kt}{uint2}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{coordinatesVec}\PYG{p}{;}
\PYG{+w}{    }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}=}\PYG{+w}{ }\PYG{n}{iMax}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{++}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{j}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{j}\PYG{+w}{ }\PYG{o}{\PYGZlt{}=}\PYG{+w}{ }\PYG{n}{jMax}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{j}\PYG{o}{++}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{flags}\PYG{p}{[}\PYG{n}{i}\PYG{p}{][}\PYG{n}{j}\PYG{p}{]}\PYG{+w}{ }\PYG{o}{\PYGZgt{}=}\PYG{+w}{ }\PYG{l+m+mb}{0b00000001}\PYG{+w}{ }\PYG{o}{\PYGZam{}\PYGZam{}}\PYG{+w}{ }\PYG{n}{flags}\PYG{p}{[}\PYG{n}{i}\PYG{p}{][}\PYG{n}{j}\PYG{p}{]}\PYG{+w}{ }\PYG{o}{\PYGZlt{}=}\PYG{+w}{ }\PYG{l+m+mb}{0b00001111}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{c+c1}{// This defines boundary cells \PYGZhy{} all cells without the self bit set except when no bits are set. This could probably be optimised.}
\PYG{+w}{                }\PYG{k+kt}{uint2}\PYG{+w}{ }\PYG{n}{coordinate}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kt}{uint2}\PYG{p}{();}
\PYG{+w}{                }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{x}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{i}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{coordinate}\PYG{p}{.}\PYG{n}{y}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{j}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{coordinatesVec}\PYG{p}{.}\PYG{n}{push\PYGZus{}back}\PYG{p}{(}\PYG{n}{coordinate}\PYG{p}{);}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{n}{coordinates}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{new}\PYG{+w}{ }\PYG{k+kt}{uint2}\PYG{p}{[}\PYG{n}{coordinatesVec}\PYG{p}{.}\PYG{n}{size}\PYG{p}{()];}\PYG{+w}{ }\PYG{c+c1}{// Allocate mem for array into already defined pointer}
\PYG{+w}{    }\PYG{n}{std}\PYG{o}{::}\PYG{n}{copy}\PYG{p}{(}\PYG{n}{coordinatesVec}\PYG{p}{.}\PYG{n}{begin}\PYG{p}{(),}\PYG{+w}{ }\PYG{n}{coordinatesVec}\PYG{p}{.}\PYG{n}{end}\PYG{p}{(),}\PYG{+w}{ }\PYG{n}{coordinates}\PYG{p}{);}\PYG{+w}{ }\PYG{c+c1}{// Copy the elements from the vector to the array}
\PYG{+w}{    }\PYG{n}{coordinatesLength}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{p}{)}\PYG{n}{coordinatesVec}\PYG{p}{.}\PYG{n}{size}\PYG{p}{();}
\PYG{p}{\PYGZcb{}}
\end{Verbatim}
